@using Microsoft.AspNetCore.Identity
@model IEnumerable<WebBanTaiKhoan.Models.Order>

@{
    ViewData["Title"] = "Lịch sử mua hàng";
}

<div class="container mt-4 pb-5">
    @* --- HEADER --- *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark mb-1">
                <i class="fa-solid fa-clock-rotate-left me-2 text-primary"></i>LỊCH SỬ ĐƠN HÀNG
            </h3>
            <p class="text-muted small mb-0">Danh sách các tài khoản bạn đã mua tại shop.</p>
        </div>
        <a asp-controller="Orders" asp-action="DepositHistory" class="btn btn-white border shadow-sm rounded-pill px-3 fw-bold text-success hover-up">
            <i class="fa-solid fa-wallet me-1"></i> Lịch sử nạp tiền
        </a>
    </div>

    @* --- BẢNG DỮ LIỆU --- *@
    <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-uppercase text-muted small fw-bold">
                        <tr>
                            <th class="ps-4 py-3">Mã đơn / Ngày</th>
                            <th>Sản phẩm</th>
                            <th>Thông tin tài khoản (User | Pass)</th>
                            <th>Tổng tiền</th>
                            <th class="text-end pe-4">Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td class="ps-4">
                                        <div class="fw-bold text-primary">#@item.OrderCode</div>
                                        <small class="text-muted">@item.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                    </td>

                                    <td>
                                        <span class="fw-bold text-dark">@(item.Product?.Name ?? "Sản phẩm đã ngừng bán")</span>
                                    </td>

                                    <td>
                                        @if (item.AccountItems != null && item.AccountItems.Any())
                                        {
                                            <div class="d-flex flex-column gap-2">
                                                @foreach (var acc in item.AccountItems)
                                                {
                                                    // Logic: Lấy Data hoặc User|Pass
                                                    string fullData = !string.IsNullOrEmpty(acc.Data)
                                                    ? acc.Data
                                                    : $"{acc.Username}|{acc.Password}";

                                                    // Tách chuỗi để hiển thị đẹp hơn
                                                    var parts = fullData.Split('|');
                                                    bool isUserPass = parts.Length >= 2;

                                                    <div class="bg-light p-2 rounded border d-flex align-items-center" style="max-width: 350px;">
                                                        <div class="text-truncate me-2 font-monospace text-dark fw-bold" style="font-size: 0.9rem;">
                                                            @if (isUserPass)
                                                            {
                                                                <span class="text-primary">@parts[0]</span>
                                                                <span class="mx-1 text-muted">|</span>
                                                                <span class="text-danger">@parts[1]</span>
                                                            }
                                                            else
                                                            {
                                                                <span>@fullData</span>
                                                            }
                                                        </div>
                                                        <button class="btn btn-sm btn-white border shadow-sm ms-auto"
                                                                onclick="copyText('@fullData')"
                                                                title="Sao chép">
                                                            <i class="fa-regular fa-copy"></i>
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted fst-italic small">Đang cập nhật...</span>
                                        }
                                    </td>

                                    <td>
                                        <span class="fw-bold text-danger">@item.TotalAmount.ToString("#,##0")đ</span>
                                    </td>

                                    <td class="text-end pe-4">
                                        <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">
                                            Success
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <img src="https://cdn-icons-png.flaticon.com/512/2038/2038854.png" width="80" class="opacity-25 mb-3" />
                                    <p class="text-muted fw-bold">Bạn chưa mua đơn hàng nào.</p>
                                    <a href="/" class="btn btn-primary btn-sm rounded-pill px-4 shadow">Mua ngay</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@* --- CSS --- *@
<style>
    .font-monospace {
        font-family: 'Consolas', monospace;
    }

    .hover-up:hover {
        transform: translateY(-2px);
        transition: 0.2s;
    }

    .btn-white {
        background: white;
        color: #333;
    }

        .btn-white:hover {
            background: #f8f9fa;
        }
</style>

@* --- SCRIPTS --- *@
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function copyText(text) {
            navigator.clipboard.writeText(text).then(function() {
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer)
                        toast.addEventListener('mouseleave', Swal.resumeTimer)
                    }
                })

                Toast.fire({
                    icon: 'success',
                    title: 'Đã sao chép thành công!'
                })
            });
        }
    </script>
}