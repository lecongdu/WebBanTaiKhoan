@model IEnumerable<WebBanTaiKhoan.Models.TopUpTransaction>
@{
    ViewData["Title"] = "Quản lý Nạp tiền";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold border-bottom border-primary border-3 pb-2">
            💸 QUẢN LÝ YÊU CẦU NẠP TIỀN
        </h2>
        <div class="d-flex gap-2">
            <a asp-controller="Admin" asp-action="Index" class="btn btn-secondary fw-bold shadow-sm">
                <i class="fa-solid fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show shadow-sm border-0 rounded-3 mb-4" role="alert">
            <i class="fa-solid fa-circle-check me-2"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show shadow-sm border-0 rounded-3 mb-4" role="alert">
            <i class="fa-solid fa-triangle-exclamation me-2"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row mb-3 g-2">
        <div class="col-md-4">
            <div class="p-2 border rounded bg-white shadow-sm small">
                <span class="badge bg-secondary me-1">Pending</span>: Khách mới xem QR
                <span class="badge bg-warning text-dark mx-1">Processing</span>: Khách đã báo nạp
                <span class="badge bg-success mx-1">Success</span>: Đã cộng tiền
            </div>
        </div>
    </div>

    <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-dark text-white py-3 fw-bold d-flex justify-content-between align-items-center">
            <span><i class="fa-solid fa-list-check me-2"></i>DANH SÁCH GIAO DỊCH</span>
            <span class="badge bg-primary">Tổng đơn: @Model.Count()</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-center">
                        <tr class="text-uppercase small fw-bold">
                            <th style="width: 15%">Thời gian</th>
                            <th style="width: 25%">Khách hàng</th>
                            <th style="width: 15%">Số tiền</th>
                            <th style="width: 20%">Nội dung / Mã</th>
                            <th style="width: 15%">Trạng thái</th>
                            <th style="width: 10%">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var item in Model.OrderByDescending(x => x.CreatedAt))
                            {
                                <tr class="@(item.Status == "Processing" ? "bg-warning bg-opacity-10" : "")">
                                    <td class="text-center small">
                                        <div class="fw-bold">@item.CreatedAt.ToString("dd/MM/yyyy")</div>
                                        <div class="text-muted">@item.CreatedAt.ToString("HH:mm:ss")</div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <img src="https://ui-avatars.com/api/?name=@(item.User?.UserName ?? "User")&background=random" class="rounded-circle" width="35">
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">@(item.User?.UserName ?? "Ẩn danh")</div>
                                                <div class="x-small text-muted">ID: #@item.Id</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="fw-bold text-danger fs-5">@item.Amount.ToString("#,##0")</span><span class="small text-danger">đ</span>
                                    </td>
                                    <td>
                                        <div class="small"><b>PT:</b> @item.Method</div>
                                        <div class="mt-1">
                                            <code class="px-2 py-1 bg-dark text-warning rounded small">@item.TransactionCode</code>
                                        </div>
                                        @if (!string.IsNullOrEmpty(item.AdminNote))
                                        {
                                            <div class="x-small text-muted mt-1 italic">Note: @item.AdminNote</div>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (item.Status == "Success")
                                        {
                                            <span class="badge bg-success-subtle text-success border border-success px-3">
                                                <i class="fa-solid fa-check-double me-1"></i> THÀNH CÔNG
                                            </span>
                                        }
                                        else if (item.Status == "Processing")
                                        {
                                            <span class="badge bg-warning text-dark border border-dark px-3 shadow-sm pulse-orange">
                                                <i class="fa-solid fa-bell me-1"></i> KHÁCH BÁO NẠP
                                            </span>
                                        }
                                        else if (item.Status == "Pending")
                                        {
                                            <span class="badge bg-light text-muted border px-3">
                                                <i class="fa-solid fa-qrcode me-1"></i> CHỜ QUÉT QR
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger px-3">ĐÃ HỦY</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (item.Status != "Success" && item.Status != "Cancelled")
                                        {
                                            <div class="d-flex flex-column gap-1">
                                                @* SỬA NÚT DUYỆT *@
                                                <button type="button" class="btn btn-success btn-sm fw-bold shadow-sm"
                                                        onclick="confirmApprove('@item.Id', '@(item.User?.UserName)', '@item.Amount.ToString("#,##0")')">
                                                    DUYỆT
                                                </button>
                                                @* SỬA NÚT HỦY *@
                                                <button type="button" class="btn btn-outline-danger btn-sm x-small"
                                                        onclick="confirmReject('@item.Id', '@(item.User?.UserName)')">
                                                    HỦY
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted small italic"><i class="fa-solid fa-lock me-1"></i>Đã xong</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <img src="https://cdn-icons-png.flaticon.com/512/4076/4076432.png" width="80" class="opacity-25 mb-3">
                                    <p class="text-muted">Chưa có giao dịch nạp tiền nào được ghi nhận.</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .rounded-4 {
        border-radius: 1rem !important;
    }

    .x-small {
        font-size: 0.7rem;
    }

    .pulse-orange {
        animation: pulse-orange-animation 2s infinite;
    }

    @@keyframes pulse-orange-animation {
        0% {
            box-shadow: 0 0 0 0px rgba(255, 193, 7, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
        }

        100% {
            box-shadow: 0 0 0 0px rgba(255, 193, 7, 0);
        }
    }

    .bg-success-subtle {
        background-color: #d1e7dd;
    }

    .italic {
        font-style: italic;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Hàm xác nhận DUYỆT (Cộng tiền)
        function confirmApprove(id, user, amount) {
            Swal.fire({
                title: 'Xác nhận cộng tiền?',
                html: `Bạn có chắc chắn muốn cộng <b class="text-success">${amount}đ</b> cho tài khoản <b>${user}</b>?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#198754',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Xác nhận cộng ngay',
                cancelButtonText: 'Hủy',
                background: '#ffffff',
                customClass: { popup: 'rounded-4 shadow' }
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Đang xử lý...',
                        didOpen: () => { Swal.showLoading() },
                        allowOutsideClick: false,
                        showConfirmButton: false
                    });
                    window.location.href = '/Admin/Approve/' + id;
                }
            });
        }

        // Hàm xác nhận HỦY đơn
        function confirmReject(id, user) {
            Swal.fire({
                title: 'Bạn muốn hủy đơn?',
                html: `Hành động này sẽ hủy yêu cầu nạp của <b>${user}</b> và không thể hoàn tác!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Vẫn hủy đơn',
                cancelButtonText: 'Quay lại',
                background: '#ffffff',
                customClass: { popup: 'rounded-4 shadow' }
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/Admin/Reject/' + id;
                }
            });
        }
    </script>
}